{% extends "main/base.html" %}

{% block title %}{{article.title}}{% endblock %}

{% block content %}

    <div class="card" id="article-{{ article.id }}">
        <div class="card-header">
            By: {{article.author}} | {{article.date_created}}
        </div>
        <div class="card-body">
            <h5 class="card-title">{{article.title}}</h5>
            <p class="card-text">{{article.content}}</p>
            <a href="{% url 'all_articles' %}" class="btn btn-primary">Back</a>
            <a href="{% url 'update_article' article.id %}" class="btn btn-primary">Update</a>
            <button onclick="deleteArticle({{ article.id }})" class="btn btn-danger">Delete</button>
            <!-- Fallback form for non-JavaScript users -->
            <form method="post" action="{% url 'delete_article' article.id %}" style="display: inline;" class="delete-form-fallback">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this article?')" style="display: none;">Delete (Fallback)</button>
            </form>
        </div>
    </div>

    <script>
        function deleteArticle(articleId) {
            if (confirm('Are you sure you want to delete this article?')) {
                fetch(`/article/delete/${articleId}/`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        // Redirect to all articles page after successful deletion
                        window.location.href = "{% url 'all_articles' %}";
                    } else {
                        alert('Error deleting article: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the article.');
                });
            }
        }

        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Show fallback forms if JavaScript is disabled
        if (typeof fetch === 'undefined') {
            document.querySelectorAll('.delete-form-fallback button').forEach(button => {
                button.style.display = 'inline-block';
            });
        }
    </script>

{% endblock %}
